<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>ë†ì´Œ ì¼Â·ê´€ê´‘ ì¶”ì²œ í…ŒìŠ¤íŠ¸</title>
    <style>
      body {
        font-family: sans-serif;
        margin: 20px;
      }
      .cards {
        display: flex;
        overflow-x: auto;
        gap: 8px;
        margin: 8px 0;
      }
      .card {
        min-width: 200px;
        padding: 12px;
        border: 1px solid #ccc;
        border-radius: 4px;
        cursor: pointer;
      }
      .card img {
        width: 100%;
        height: 120px;
        object-fit: cover;
        border-radius: 4px;
        margin-bottom: 8px;
        transition: opacity 0.3s ease;
      }
      .card .no-image {
        width: 100%;
        height: 120px;
        background: #f0f0f0;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
        margin-bottom: 8px;
        color: #666;
        font-size: 12px;
      }
      .card .loading-image {
        width: 100%;
        height: 120px;
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 200% 100%;
        animation: loading 1.5s infinite;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
        margin-bottom: 8px;
        color: #888;
        font-size: 12px;
      }
      @keyframes loading {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
      }
      .loading-text {
        color: #007bff;
        font-style: italic;
        margin-top: 8px;
      }
      .card.selected {
        border-color: #007bff;
        background: #e7f1ff;
      }
      #itinerary {
        white-space: pre-wrap;
        background: #f9f9f9;
        padding: 12px;
        border: 1px solid #ddd;
        margin-top: 8px;
      }
    </style>
  </head>
  <body>
    <h2>1. ìì—°ì–´ ìš”ì²­</h2>
    <textarea
      id="userQuery"
      rows="2"
      cols="60"
      placeholder="ì˜ˆ) 9ì›” ì²«ì§¸ ì£¼ ê³ ì°½ì—ì„œ ì¡°ê°œì¡ì´ + í•´ë³€ ê´€ê´‘í•˜ê³  ì‹¶ì–´ìš”"
    ></textarea>
    <br />
    <button onclick="loadPreviews()">ìŠ¬ë¡¯ ì¶”ì¶œ & ì¹´ë“œ ë³´ê¸°</button>

    <h2>2. ì¼ê±°ë¦¬ ì¹´ë“œ (ìµœëŒ€ 10ê°œ)</h2>
    <div id="jobs" class="cards"></div>

    <h2>3. ê´€ê´‘ì§€ ì¹´ë“œ (ìµœëŒ€ 10ê°œ)</h2>
    <div id="tours" class="cards"></div>

    <h2>4. ì„ íƒ í›„ ì¼ì • ìƒì„±</h2>
    <button onclick="generateItinerary()">ìµœì¢… ì¼ì • ìƒì„±</button>

    <h2>ìƒì„±ëœ ì¼ì • JSON</h2>
    <div id="itinerary"></div>

    <script>
      let currentSlots = null;
      let jobsPreview = [],
        toursPreview = [];

      async function loadPreviews() {
        const query = document.getElementById("userQuery").value;
        
        // ë¡œë”© ìƒíƒœ í‘œì‹œ
        document.getElementById("jobs").innerHTML = '<div class="loading-text">ì¼ê±°ë¦¬ ì¹´ë“œ ë¡œë”© ì¤‘...</div>';
        document.getElementById("tours").innerHTML = '<div class="loading-text">ê´€ê´‘ì§€ ì¹´ë“œ ë° ì´ë¯¸ì§€ ë¡œë”© ì¤‘...</div>';
        
        try {
          const resp = await fetch("/slots", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ query: query }),
          });
          
          if (!resp.ok) {
            throw new Error(`HTTP ${resp.status}: ${resp.statusText}`);
          }
          
          const data = await resp.json();
          currentSlots = data.slots;
          jobsPreview = data.jobs_preview;
          toursPreview = data.tours_preview;
          
          renderCards("jobs", jobsPreview, "job_id", "tags");
          renderCards("tours", toursPreview, "content_id", "overview");
          
          console.log("âœ… ì¹´ë“œ ë¡œë”© ì™„ë£Œ:", {
            jobs: jobsPreview.length,
            tours: toursPreview.length,
            images: toursPreview.filter(t => t.image_url).length
          });
          
        } catch (error) {
          console.error("âŒ ì¹´ë“œ ë¡œë”© ì‹¤íŒ¨:", error);
          document.getElementById("jobs").innerHTML = '<div style="color: red;">ì¼ê±°ë¦¬ ë¡œë”© ì‹¤íŒ¨</div>';
          document.getElementById("tours").innerHTML = '<div style="color: red;">ê´€ê´‘ì§€ ë¡œë”© ì‹¤íŒ¨</div>';
        }
      }

      function renderCards(containerId, items, key, textField) {
        const cont = document.getElementById(containerId);
        cont.innerHTML = "";
        items.forEach((item) => {
          const card = document.createElement("div");
          card.className = "card";
          card.dataset.id = item[key];
          // farm_name or title
          const title = item.farm_name || item.title;
          const region = item.region || "ì§€ì—­ì •ë³´ì—†ìŒ";
          const desc = item[textField] || "";
          
          // ğŸ”¥ NEW: ê´€ê´‘ì§€ ì¹´ë“œì¸ ê²½ìš° ì´ë¯¸ì§€ ì¶”ê°€
          let imageHTML = "";
          if (containerId === "tours" && item.image_url) {
            imageHTML = `<img src="${item.image_url}" alt="${title}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                         <div class="no-image" style="display:none;">ì´ë¯¸ì§€ ì—†ìŒ</div>`;
          } else if (containerId === "tours") {
            imageHTML = `<div class="no-image">ì´ë¯¸ì§€ ì—†ìŒ</div>`;
          }
          
          card.innerHTML = `${imageHTML}<strong>${title}</strong><p><em>ğŸ“ ${region}</em></p><p>${desc}</p>`;
          card.onclick = () => card.classList.toggle("selected");
          cont.append(card);
        });
      }

      async function generateItinerary() {
        const selectedJobs = Array.from(
          document.querySelectorAll("#jobs .card.selected")
        ).map((el) => parseInt(el.dataset.id));
        const selectedTours = Array.from(
          document.querySelectorAll("#tours .card.selected")
        ).map((el) => parseInt(el.dataset.id));

        const payload = {
          query: document.getElementById("userQuery").value,
          user_id: null,
          budget: 500000,
          selected_jobs: selectedJobs,
          selected_tours: selectedTours,
        };
        const resp = await fetch("/recommend", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        // ì „ì²´ ì‘ë‹µì´ ScheduleItem ë°°ì—´ë¡œ ëŒì•„ì˜µë‹ˆë‹¤.
        const data = await resp.json();
        // ì´ê±¸ ê·¸ëŒ€ë¡œ ì¶œë ¥
        document.getElementById("itinerary").textContent = JSON.stringify(
          data,
          null,
          2
        );
      }
    </script>
  </body>
</html>
