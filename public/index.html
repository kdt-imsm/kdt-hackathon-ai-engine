<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>üåæ ÏùºÎ©çÏâ¨Î©ç - Ï¢ÖÌï© ÌÖåÏä§Ìä∏</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        color: #333;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
      }

      .header {
        text-align: center;
        color: white;
        margin-bottom: 30px;
      }

      .header h1 {
        font-size: 2.5em;
        margin-bottom: 10px;
      }

      .header p {
        font-size: 1.1em;
        opacity: 0.9;
      }

      .main-content {
        background: white;
        border-radius: 20px;
        padding: 30px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      }

      .step-container {
        margin-bottom: 40px;
        padding: 25px;
        border: 2px solid #e9ecef;
        border-radius: 15px;
        transition: all 0.3s ease;
      }

      .step-container.active {
        border-color: #667eea;
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
      }

      .step-header {
        display: flex;
        align-items: center;
        margin-bottom: 20px;
      }

      .step-number {
        background: #667eea;
        color: white;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        margin-right: 15px;
      }

      .step-title {
        font-size: 1.3em;
        font-weight: 600;
        color: #333;
      }

      .step-status {
        margin-left: auto;
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 0.9em;
        font-weight: 500;
      }

      .step-status.pending {
        background: #f8f9fa;
        color: #6c757d;
      }

      .step-status.processing {
        background: #fff3cd;
        color: #856404;
      }

      .step-status.completed {
        background: #d1edff;
        color: #0c63e4;
      }

      .input-group {
        margin-bottom: 20px;
      }

      .input-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: #555;
      }

      .input-group input,
      .input-group textarea {
        width: 100%;
        padding: 12px;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        font-size: 1em;
        transition: border-color 0.3s ease;
      }

      .input-group input:focus,
      .input-group textarea:focus {
        outline: none;
        border-color: #667eea;
      }

      .btn {
        background: #667eea;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 1em;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      .btn:hover {
        background: #5a67d8;
        transform: translateY(-2px);
      }

      .btn:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
      }

      .cards-container {
        display: flex;
        flex-direction: column;
        gap: 30px;
        margin: 20px 0;
      }

      .cards-section {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 12px;
      }

      .cards-section h3 {
        margin-bottom: 15px;
        color: #333;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .cards-grid {
        display: flex;
        gap: 15px;
        overflow-x: auto;
        padding-bottom: 10px;
        scroll-behavior: smooth;
      }

      .cards-grid::-webkit-scrollbar {
        height: 8px;
      }

      .cards-grid::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
      }

      .cards-grid::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 4px;
      }

      .cards-grid::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8;
      }

      .card {
        background: white;
        border: 2px solid #e9ecef;
        border-radius: 10px;
        padding: 15px;
        cursor: pointer;
        transition: all 0.3s ease;
        min-width: 280px;
        flex-shrink: 0;
      }

      .card:hover {
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }

      .card.selected {
        border-color: #667eea;
        background: #f0f4ff;
      }

      .card img {
        width: 100%;
        height: 120px;
        object-fit: cover;
        border-radius: 8px;
        margin-bottom: 10px;
      }

      .card .no-image {
        width: 100%;
        height: 120px;
        background: #e9ecef;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #6c757d;
        margin-bottom: 10px;
      }

      .card-title {
        font-weight: 600;
        margin-bottom: 5px;
        color: #333;
      }

      .card-location {
        color: #667eea;
        font-size: 0.9em;
        margin-bottom: 8px;
      }

      .card-description {
        font-size: 0.85em;
        color: #666;
        line-height: 1.4;
      }

      .keyword-tag {
        background: #667eea;
        color: white;
        padding: 2px 6px;
        border-radius: 12px;
        font-size: 0.75em;
        margin-right: 4px;
      }

      .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 2px solid #f3f3f3;
        border-top: 2px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .process-visualizer {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 12px;
        margin: 20px 0;
      }

      .process-step {
        display: flex;
        align-items: center;
        padding: 10px;
        margin: 5px 0;
        border-radius: 8px;
        transition: all 0.3s ease;
      }

      .process-step.active {
        background: #fff3cd;
        border-left: 4px solid #ffc107;
      }

      .process-step.completed {
        background: #d1edff;
        border-left: 4px solid #0c63e4;
      }

      .process-icon {
        width: 24px;
        margin-right: 12px;
      }

      .itinerary-result {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 12px;
        margin: 20px 0;
      }

      .itinerary-content {
        background: white;
        padding: 20px;
        border-radius: 8px;
        white-space: pre-wrap;
        line-height: 1.6;
      }

      .feedback-controls {
        display: flex;
        gap: 10px;
        margin: 15px 0;
      }

      .feedback-btn {
        background: #28a745;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.9em;
      }

      .feedback-btn.secondary {
        background: #6c757d;
      }

      .session-info {
        background: #e8f4f8;
        padding: 10px;
        border-radius: 8px;
        margin: 10px 0;
        font-size: 0.9em;
        color: #333;
      }

      .execution-stats {
        display: flex;
        gap: 20px;
        margin: 15px 0;
      }

      .stat-item {
        text-align: center;
        padding: 10px;
        background: white;
        border-radius: 8px;
        flex: 1;
      }

      .stat-value {
        font-size: 1.5em;
        font-weight: 600;
        color: #667eea;
      }

      .stat-label {
        font-size: 0.9em;
        color: #666;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>ÏùºÎ©çÏâ¨Î©ç AI Í∏∞Îä• ÌÖåÏä§Ìä∏</h1>
        <p>AI Í∏∞Î∞ò Í∞úÏù∏ ÎßûÏ∂§Ìòï ÎÜçÏ¥å ÏùºÏûêÎ¶¨¬∑Í¥ÄÍ¥ë ÌÜµÌï© Ï∂îÏ≤ú Î∞è Ïä§ÎßàÌä∏ Ïä§ÏºÄÏ§ÑÎßÅ</p>
      </div>

      <div class="main-content">
        <!-- STEP 1: ÏûêÏó∞Ïñ¥ ÏûÖÎ†• -->
        <div class="step-container" id="step1">
          <div class="step-header">
            <div class="step-number">1</div>
            <div class="step-title">ÏûêÏó∞Ïñ¥ ÏûÖÎ†• Î∞è Ïä¨Î°Ø Ï∂îÏ∂ú</div>
            <div class="step-status pending" id="status1">ÎåÄÍ∏∞Ï§ë</div>
          </div>
          <div class="input-group">
            <label for="userQuery"
              >Ïñ∏Ï†ú, Ïñ¥ÎîîÏÑú, Î¨¥ÏóáÏùÑ ÌïòÍ≥† Ïã∂ÏùÄÏßÄ ÏûÖÎ†•Ìï¥ Ï£ºÏÑ∏Ïöî.</label
            >
            <textarea
              id="userQuery"
              rows="3"
              placeholder="Ïòà: 9ÏõîÏóê Ï†úÏ£ºÏóêÏÑú ÎÜçÏû• ÏùºÍ±∞Î¶¨ ÎèïÍ≥† Î∞îÎã§ Íµ¨Í≤ΩÌïòÍ≥† Ïã∂Ïñ¥"
            ></textarea>
          </div>
          <button class="btn" onclick="extractSlots()">
            <span
              class="loading-spinner"
              id="loading1"
              style="display: none"
            ></span>
            Ïä¨Î°Ø Ï∂îÏ∂ú Î∞è Ïπ¥Îìú Í≤ÄÏÉâ
          </button>

          <div class="process-visualizer" id="process1" style="display: none">
            <h4>Ï≤òÎ¶¨ Í≥ºÏ†ï</h4>
            <div class="process-step" id="process1-nlp">
              <span class="process-icon">‚ñ∂Ô∏è</span>
              <span>GPT-4o-mini ÏûêÏó∞Ïñ¥ Î∂ÑÏÑù Ï§ë...</span>
            </div>
            <div class="process-step" id="process1-vector">
              <span class="process-icon">‚ñ∂Ô∏è</span>
              <span>Î≤°ÌÑ∞ Ïú†ÏÇ¨ÎèÑ Í≤ÄÏÉâ Ï§ë...</span>
            </div>
            <div class="process-step" id="process1-ranking">
              <span class="process-icon">‚ñ∂Ô∏è</span>
              <span>Í∞úÏù∏Ìôî Îû≠ÌÇπ Ï†ÅÏö© Ï§ë...</span>
            </div>
          </div>
        </div>

        <!-- STEP 2: Ïπ¥Îìú ÏÑ†ÌÉù -->
        <div class="step-container" id="step2">
          <div class="step-header">
            <div class="step-number">2</div>
            <div class="step-title">AI Ï∂îÏ≤ú Ïπ¥Îìú ÏÑ†ÌÉù</div>
            <div class="step-status pending" id="status2">ÎåÄÍ∏∞Ï§ë</div>
          </div>

          <div
            class="cards-container"
            id="cardsContainer"
            style="display: none"
          >
            <div class="cards-section">
              <h3>üåæ Ï∂îÏ≤ú! ÎÜçÏ¥å Ï≤¥Ìóò Î∞è ÏÜåÏùºÍ±∞Î¶¨ ‚òÄ Ô∏é</h3>
              <div class="cards-grid" id="jobCards"></div>
            </div>
            <div class="cards-section">
              <h3>Ï∂îÏ≤ú! ÌÖåÎßà Ïó¨Ìñâ ‚ô•Ô∏é</h3>
              <div class="cards-grid" id="tourCards"></div>
            </div>
          </div>

          <div class="execution-stats" id="step2Stats" style="display: none">
            <div class="stat-item">
              <div class="stat-value" id="jobCount">0</div>
              <div class="stat-label">ÏÑ†ÌÉùÎêú ÏùºÏûêÎ¶¨</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="tourCount">0</div>
              <div class="stat-label">ÏÑ†ÌÉùÎêú Í¥ÄÍ¥ëÏßÄ</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="totalCards">0</div>
              <div class="stat-label">Ï†ÑÏ≤¥ Ï∂îÏ≤ú Ïπ¥Îìú</div>
            </div>
          </div>

          <button
            class="btn"
            onclick="generateSmartItinerary()"
            id="generateBtn"
            style="display: none"
          >
            <span
              class="loading-spinner"
              id="loading2"
              style="display: none"
            ></span>
            AI Ïä§ÎßàÌä∏ ÏùºÏ†ï ÏÉùÏÑ±
          </button>
        </div>

        <!-- STEP 3: Ïä§ÎßàÌä∏ Ïä§ÏºÄÏ§ÑÎßÅ -->
        <div class="step-container" id="step3">
          <div class="step-header">
            <div class="step-number">3</div>
            <div class="step-title">GPT-4o Í∏∞Î∞ò ÏßÄÎä•Ìòï Ïä§ÏºÄÏ§ÑÎßÅ</div>
            <div class="step-status pending" id="status3">ÎåÄÍ∏∞Ï§ë</div>
          </div>

          <div class="process-visualizer" id="process3" style="display: none">
            <h4>Agent Í∏∞Î∞ò ÏµúÏ†ÅÌôî Í≥ºÏ†ï</h4>
            <div class="process-step" id="process3-geo">
              <span class="process-icon">‚ñ∂Ô∏è</span>
              <span>ÏßÄÎ¶¨Ï†Å ÏµúÏ†ÅÌôî Î∂ÑÏÑù Ï§ë...</span>
            </div>
            <div class="process-step" id="process3-time">
              <span class="process-icon">‚ñ∂Ô∏è</span>
              <span>ÏãúÍ∞ÑÏ†Å ÏµúÏ†ÅÌôî Î∂ÑÏÑù Ï§ë...</span>
            </div>
            <div class="process-step" id="process3-personal">
              <span class="process-icon">‚ñ∂Ô∏è</span>
              <span>Í∞úÏù∏Ìôî ÎßûÏ∂§ Î∞∞Ïπò Ï§ë...</span>
            </div>
            <div class="process-step" id="process3-generate">
              <span class="process-icon">‚ñ∂Ô∏è</span>
              <span>ÏûêÏó∞Ïñ¥ ÏùºÏ†ï ÏÉùÏÑ± Ï§ë...</span>
            </div>
          </div>

          <div class="session-info" id="sessionInfo" style="display: none">
            <strong>üîó ÏÑ∏ÏÖò ID:</strong> <span id="sessionId">-</span>
          </div>

          <div
            class="itinerary-result"
            id="itineraryResult"
            style="display: none"
          >
            <h4>üìÖ ÏÉùÏÑ±Îêú Í∞úÏù∏ ÎßûÏ∂§ ÏùºÏ†ï</h4>
            <div class="itinerary-content" id="itineraryContent"></div>

            <div class="execution-stats">
              <div class="stat-item">
                <div class="stat-value" id="execTime">0</div>
                <div class="stat-label">Ïã§ÌñâÏãúÍ∞Ñ (Ï¥à)</div>
              </div>
              <div class="stat-item">
                <div class="stat-value" id="agentCalls">0</div>
                <div class="stat-label">Agent Ìò∏Ï∂ú Ïàò</div>
              </div>
              <div class="stat-item">
                <div class="stat-value" id="optimizedDays">0</div>
                <div class="stat-label">ÏµúÏ†ÅÌôîÎêú ÏùºÏàò</div>
              </div>
            </div>

            <div class="feedback-controls">
              <button
                class="feedback-btn"
                onclick="testItineraryFeedback('positive')"
              >
                üëç ÏùºÏ†ïÏù¥ Ï¢ãÏïÑÏöî
              </button>
              <button
                class="feedback-btn secondary"
                onclick="testItineraryFeedback('modify')"
              >
                ‚úèÔ∏è ÏàòÏ†ï ÏöîÏ≤≠ (ÌÖåÏä§Ìä∏)
              </button>
              <button
                class="feedback-btn secondary"
                onclick="testItineraryFeedback('regenerate')"
              >
                üîÑ Îã§Ïãú ÏÉùÏÑ±
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      let currentSlots = null;
      let currentJobCards = [];
      let currentTourCards = [];
      let currentSessionId = null;

      // STEP 1: Ïä¨Î°Ø Ï∂îÏ∂ú Î∞è Ïπ¥Îìú Í≤ÄÏÉâ
      async function extractSlots() {
        const query = document.getElementById("userQuery").value.trim();
        if (!query) {
          alert("ÏûêÏó∞Ïñ¥ ÏøºÎ¶¨Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.");
          return;
        }

        // UI ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
        setStepStatus(1, "processing");
        setLoading(1, true);
        document.getElementById("process1").style.display = "block";

        try {
          // ÌîÑÎ°úÏÑ∏Ïä§ ÏãúÍ∞ÅÌôî
          await animateProcess("process1-nlp", 1000);
          await animateProcess("process1-vector", 1500);
          await animateProcess("process1-ranking", 800);

          const response = await fetch("/slots", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ query: query }),
          });

          const data = await response.json();

          if (data.success) {
            currentSlots = data.slots;
            currentJobCards = data.jobs_preview || [];
            currentTourCards = data.tours_preview || [];

            // Ïπ¥Îìú Î†åÎçîÎßÅ
            renderCards();

            // STEP 1 ÏôÑÎ£å, STEP 2 ÌôúÏÑ±Ìôî
            setStepStatus(1, "completed");
            setStepStatus(2, "processing");
            document.getElementById("step2").classList.add("active");

            // ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
            updateCardStats();
          } else {
            throw new Error(data.error || "Ïä¨Î°Ø Ï∂îÏ∂ú Ïã§Ìå®");
          }
        } catch (error) {
          console.error("Error:", error);
          alert("Ïä¨Î°Ø Ï∂îÏ∂ú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: " + error.message);
          setStepStatus(1, "pending");
        } finally {
          setLoading(1, false);
        }
      }

      // Ïπ¥Îìú Î†åÎçîÎßÅ
      function renderCards() {
        renderJobCards();
        renderTourCards();

        document.getElementById("cardsContainer").style.display = "grid";
        document.getElementById("step2Stats").style.display = "flex";
        document.getElementById("generateBtn").style.display = "inline-flex";
      }

      function renderJobCards() {
        const container = document.getElementById("jobCards");
        container.innerHTML = "";

        currentJobCards.forEach((job) => {
          const card = document.createElement("div");
          card.className = "card";
          card.dataset.id = job.job_id;
          card.dataset.type = "job";

          const imageHtml = job.image_url
            ? `<img src="${job.image_url}" alt="${job.farm_name}">`
            : `<div class="no-image">Ïù¥ÎØ∏ÏßÄ ÏóÜÏùå</div>`;

          card.innerHTML = `
                    ${imageHtml}
                    <div class="card-title">${job.farm_name}</div>
                    <div class="card-location">üìç ${job.region}</div>
                    <div class="card-description">${
                      job.tags ? job.tags.join(", ") : "ÎÜçÏ¥å ÏùºÏûêÎ¶¨"
                    }</div>
                `;

          card.onclick = () => toggleCardSelection(card);
          container.appendChild(card);
        });
      }

      function renderTourCards() {
        const container = document.getElementById("tourCards");
        container.innerHTML = "";

        currentTourCards.forEach((tour) => {
          const card = document.createElement("div");
          card.className = "card";
          card.dataset.id = tour.content_id;
          card.dataset.type = "tour";

          const imageHtml = tour.image_url
            ? `<img src="${tour.image_url}" alt="${tour.title}">`
            : `<div class="no-image">Ïù¥ÎØ∏ÏßÄ ÏóÜÏùå</div>`;

          const keywordHtml =
            tour.matched_keywords && tour.matched_keywords.length > 0
              ? `<div style="margin: 8px 0;">${tour.matched_keywords
                  .map((kw) => `<span class="keyword-tag">${kw}</span>`)
                  .join("")}</div>`
              : "";

          card.innerHTML = `
                    ${imageHtml}
                    <div class="card-title">${tour.title}</div>
                    <div class="card-location">üìç ${tour.region}</div>
                    ${keywordHtml}
                    <div class="card-description">${tour.overview}</div>
                `;

          card.onclick = () => toggleCardSelection(card);
          container.appendChild(card);
        });
      }

      function toggleCardSelection(card) {
        card.classList.toggle("selected");
        updateCardStats();
      }

      function updateCardStats() {
        const selectedJobs = document.querySelectorAll(
          "#jobCards .card.selected"
        ).length;
        const selectedTours = document.querySelectorAll(
          "#tourCards .card.selected"
        ).length;
        const totalCards = currentJobCards.length + currentTourCards.length;

        document.getElementById("jobCount").textContent = selectedJobs;
        document.getElementById("tourCount").textContent = selectedTours;
        document.getElementById("totalCards").textContent = totalCards;
      }

      // STEP 3: Ïä§ÎßàÌä∏ ÏùºÏ†ï ÏÉùÏÑ±
      async function generateSmartItinerary() {
        console.log("generateSmartItinerary ÏãúÏûë");

        const selectedJobCards = document.querySelectorAll(
          "#jobCards .card.selected"
        );
        const selectedTourCards = document.querySelectorAll(
          "#tourCards .card.selected"
        );

        console.log("ÏÑ†ÌÉùÎêú ÏùºÏûêÎ¶¨ Ïπ¥Îìú Ïàò:", selectedJobCards.length);
        console.log("ÏÑ†ÌÉùÎêú Í¥ÄÍ¥ëÏßÄ Ïπ¥Îìú Ïàò:", selectedTourCards.length);

        const selectedJobs = Array.from(selectedJobCards)
          .map((card) => {
            const id = parseInt(card.dataset.id);
            console.log("ÏùºÏûêÎ¶¨ Ïπ¥Îìú ID:", card.dataset.id, "-> ÌååÏã±:", id);
            return id;
          })
          .filter((id) => !isNaN(id) && id > 0);

        const selectedTours = Array.from(selectedTourCards)
          .map((card) => {
            const id = parseInt(card.dataset.id);
            console.log("Í¥ÄÍ¥ëÏßÄ Ïπ¥Îìú ID:", card.dataset.id, "-> ÌååÏã±:", id);
            return id;
          })
          .filter((id) => !isNaN(id) && id > 0);

        console.log("ÏµúÏ¢Ö ÏÑ†ÌÉùÎêú ÏùºÏûêÎ¶¨ IDs:", selectedJobs);
        console.log("ÏµúÏ¢Ö ÏÑ†ÌÉùÎêú Í¥ÄÍ¥ëÏßÄ IDs:", selectedTours);

        if (selectedJobs.length === 0 && selectedTours.length === 0) {
          alert("ÏµúÏÜå ÌïòÎÇòÏùò Ïπ¥ÎìúÎ•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.");
          return;
        }

        // UI ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
        setStepStatus(2, "completed");
        setStepStatus(3, "processing");
        document.getElementById("step3").classList.add("active");
        setLoading(2, true);
        document.getElementById("process3").style.display = "block";

        try {
          // ÌîÑÎ°úÏÑ∏Ïä§ ÏãúÍ∞ÅÌôî
          await animateProcess("process3-geo", 2000);
          await animateProcess("process3-time", 1500);
          await animateProcess("process3-personal", 2500);
          await animateProcess("process3-generate", 1000);

          const payload = {
            query: document.getElementById("userQuery").value,
            user_id: null,
            budget: 500000,
            selected_jobs: selectedJobs,
            selected_tours: selectedTours,
          };

          const response = await fetch("/smart-schedule", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          const data = await response.json();

          if (data.success) {
            currentSessionId = data.session_id;

            // Í≤∞Í≥º ÌëúÏãú
            document.getElementById("sessionId").textContent =
              currentSessionId || "N/A";
            document.getElementById("sessionInfo").style.display = "block";
            document.getElementById("itineraryContent").textContent =
              data.natural_language_itinerary || "ÏùºÏ†ï ÏÉùÏÑ± Ïã§Ìå®";
            document.getElementById("itineraryResult").style.display = "block";

            // ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
            document.getElementById("execTime").textContent = (
              data.execution_time || 0
            ).toFixed(2);
            document.getElementById("agentCalls").textContent = data.agent_notes
              ? data.agent_notes.length
              : 0;

            // ÏùºÏàò Í≥ÑÏÇ∞ (Í∞ÑÎã® Ï∂îÏ†ï)
            const scheduleLines =
              (data.natural_language_itinerary || "").split("ÏùºÏ∞®").length - 1;
            document.getElementById("optimizedDays").textContent =
              scheduleLines || 0;

            setStepStatus(3, "completed");
          } else {
            throw new Error(data.error_message || "ÏùºÏ†ï ÏÉùÏÑ± Ïã§Ìå®");
          }
        } catch (error) {
          console.error("Error:", error);
          alert("Ïä§ÎßàÌä∏ ÏùºÏ†ï ÏÉùÏÑ± Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: " + error.message);
          setStepStatus(3, "pending");
        } finally {
          setLoading(2, false);
        }
      }

      // ÌîºÎìúÎ∞± ÌÖåÏä§Ìä∏
      async function testItineraryFeedback(type) {
        if (!currentSessionId) {
          alert("ÏÑ∏ÏÖò IDÍ∞Ä ÏóÜÏäµÎãàÎã§.");
          return;
        }

        let modifications = [];

        if (type === "modify") {
          // ÌÖåÏä§Ìä∏Ïö© ÏàòÏ†ïÏÇ¨Ìï≠
          modifications = [
            {
              type: "change_time",
              date: "2025-09-01",
              activity_id: "1",
              new_start_time: "10:00",
              new_end_time: "15:00",
            },
          ];
        } else if (type === "regenerate") {
          // Ï†ÑÏ≤¥ Ïû¨ÏÉùÏÑ± (Îπà ÏàòÏ†ïÏÇ¨Ìï≠ÏúºÎ°ú Ïû¨ÏµúÏ†ÅÌôî ÏöîÏ≤≠)
          modifications = [];
        }

        try {
          const response = await fetch("/itinerary/feedback", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              session_id: currentSessionId,
              modifications: modifications,
              user_preferences: { activity_style: "relaxed" },
            }),
          });

          const data = await response.json();

          if (data.success) {
            if (data.updated_itinerary) {
              document.getElementById("itineraryContent").textContent =
                data.updated_itinerary;
            }

            const changesText = data.changes_summary
              ? "\n\nÎ≥ÄÍ≤ΩÏÇ¨Ìï≠:\n" + data.changes_summary.join("\n")
              : "";

            alert(
              `ÌîºÎìúÎ∞± Ï≤òÎ¶¨ ÏôÑÎ£å! (${(data.execution_time || 0).toFixed(
                2
              )}Ï¥à)${changesText}`
            );
          } else {
            alert("ÌîºÎìúÎ∞± Ï≤òÎ¶¨ Ïã§Ìå®: " + (data.error || "Ïïå Ïàò ÏóÜÎäî Ïò§Î•ò"));
          }
        } catch (error) {
          console.error("Error:", error);
          alert("ÌîºÎìúÎ∞± Ï≤òÎ¶¨ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: " + error.message);
        }
      }

      // Ïú†Ìã∏Î¶¨Ìã∞ Ìï®ÏàòÎì§
      function setStepStatus(step, status) {
        const statusElement = document.getElementById(`status${step}`);
        statusElement.className = `step-status ${status}`;

        const statusText = {
          pending: "ÎåÄÍ∏∞Ï§ë",
          processing: "Ï≤òÎ¶¨Ï§ë",
          completed: "ÏôÑÎ£å",
        };

        statusElement.textContent = statusText[status] || status;
      }

      function setLoading(step, isLoading) {
        const spinner = document.getElementById(`loading${step}`);
        if (spinner) {
          spinner.style.display = isLoading ? "inline-block" : "none";
        }
      }

      async function animateProcess(elementId, duration) {
        const element = document.getElementById(elementId);
        if (element) {
          element.classList.add("active");
          await new Promise((resolve) => setTimeout(resolve, duration));
          element.classList.remove("active");
          element.classList.add("completed");
        }
      }

      // Ï¥àÍ∏∞Ìôî
      document.addEventListener("DOMContentLoaded", function () {
        // ÏòàÏãú ÏøºÎ¶¨ ÏÑ§Ï†ï
        document.getElementById("userQuery").value =
          "9ÏõîÏóê Ï†úÏ£ºÏóêÏÑú ÎÜçÏû• ÏùºÍ±∞Î¶¨ ÎèïÍ≥† Î∞îÎã§ Íµ¨Í≤ΩÌïòÍ≥† Ïã∂Ïñ¥";
      });
    </script>
  </body>
</html>
