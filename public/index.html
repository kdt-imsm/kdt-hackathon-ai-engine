<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>
      ì „ë¶ ë†ì´Œ ì¼ì—¬í–‰ ì‹œìŠ¤í…œ - System_Improvements.md ìš”êµ¬ì‚¬í•­ êµ¬í˜„
    </title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Noto Sans KR", sans-serif;
        background-color: #f8f9fa;
      }
      .hero-section {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 4rem 0;
        margin-bottom: 2rem;
      }
      .step-indicator {
        display: flex;
        justify-content: center;
        margin-bottom: 2rem;
      }
      .step {
        padding: 0.5rem 1rem;
        margin: 0 0.5rem;
        border-radius: 25px;
        background: #e9ecef;
        color: #6c757d;
      }
      .step.active {
        background: #007bff;
        color: white;
      }
      .step.completed {
        background: #28a745;
        color: white;
      }
      .card-hover {
        transition: transform 0.2s, box-shadow 0.2s;
        cursor: pointer;
      }
      .card-hover:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }
      .card.selected {
        border-color: #007bff;
        border-width: 2px;
        background-color: #f8f9ff;
      }
      .preference-tag {
        background: #e9ecef;
        border: 1px solid #ced4da;
        color: #495057;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        margin: 0.25rem;
        cursor: pointer;
        transition: all 0.2s;
      }
      .preference-tag.selected {
        background: #007bff;
        border-color: #007bff;
        color: white;
      }
      .preference-tag:hover {
        background: #dee2e6;
      }
      .preference-tag.selected:hover {
        background: #0056b3;
      }
      .loading {
        display: none;
        text-align: center;
        padding: 2rem;
      }
      .spinner-border {
        width: 3rem;
        height: 3rem;
      }
    </style>
  </head>
  <body>
    <!-- Hero Section -->
    <div class="hero-section">
      <div class="container text-center">
        <h1 class="display-4 mb-3">ğŸŒ¾ ì „ë¶ ë†ì´Œ ì¼ì—¬í–‰ ì‹œìŠ¤í…œ</h1>
        <p class="lead">System_Improvements.md ìš”êµ¬ì‚¬í•­ì— ë”°ë¥¸ ì •í™•í•œ êµ¬í˜„</p>
      </div>
    </div>

    <div class="container">
      <!-- Step Indicator -->
      <div class="step-indicator">
        <div class="step active" id="step1">1. ì„ í˜¸ë„ ì„¤ì •</div>
        <div class="step" id="step2">2. ì¶”ì²œ ê²°ê³¼</div>
        <div class="step" id="step3">3. ì¼ì • ìƒì„±</div>
      </div>

      <!-- Step 1: ì„ í˜¸ë„ ì„¤ì • + ìì—°ì–´ ì…ë ¥ -->
      <div id="preference-section" class="mb-5">
        <div class="row justify-content-center">
          <div class="col-md-10">
            <div class="card">
              <div class="card-header">
                <h3>
                  <i class="fas fa-heart text-danger me-2"></i>ì„ í˜¸ë„ ì„¤ì • ë°
                  ì—¬í–‰ ìš”ì²­ ì‚¬í•­
                </h3>
              </div>
              <div class="card-body">
                <!-- 1. í’ê²½ ì„ í˜¸ë„ (5ê°œ) -->
                <div class="mb-4">
                  <h5>
                    <i class="fas fa-mountain text-success me-2"></i>ì–´ë–¤ í’ê²½ì„
                    ì¢‹ì•„í•˜ì‹œë‚˜ìš”? (5ê°œ ì¤‘ ì„ íƒ)
                  </h5>
                  <div class="d-flex flex-wrap gap-2 mt-3">
                    <div
                      class="preference-tag"
                      data-type="landscape"
                      data-value="ì‚°"
                    >
                      ì‚°
                    </div>
                    <div
                      class="preference-tag"
                      data-type="landscape"
                      data-value="ë°”ë‹¤"
                    >
                      ë°”ë‹¤
                    </div>
                    <div
                      class="preference-tag"
                      data-type="landscape"
                      data-value="ê°•Â·í˜¸ìˆ˜"
                    >
                      ê°•Â·í˜¸ìˆ˜
                    </div>
                    <div
                      class="preference-tag"
                      data-type="landscape"
                      data-value="ìˆ²"
                    >
                      ìˆ²
                    </div>
                    <div
                      class="preference-tag"
                      data-type="landscape"
                      data-value="ì„¬"
                    >
                      ì„¬
                    </div>
                  </div>
                </div>

                <!-- 2. ì—¬í–‰ ìŠ¤íƒ€ì¼ ì„ í˜¸ë„ (8ê°œ) -->
                <div class="mb-4">
                  <h5>
                    <i class="fas fa-hiking text-info me-2"></i>ì–´ë–¤ ì—¬í–‰
                    ìŠ¤íƒ€ì¼ì„ ì„ í˜¸í•˜ì‹œë‚˜ìš”? (8ê°œ ì¤‘ ì„ íƒ)
                  </h5>
                  <div class="d-flex flex-wrap gap-2 mt-3">
                    <div
                      class="preference-tag"
                      data-type="travel_style"
                      data-value="íë§Â·ì—¬ìœ "
                    >
                      íë§Â·ì—¬ìœ 
                    </div>
                    <div
                      class="preference-tag"
                      data-type="travel_style"
                      data-value="ì²´í—˜í˜•"
                    >
                      ì²´í—˜í˜•
                    </div>
                    <div
                      class="preference-tag"
                      data-type="travel_style"
                      data-value="ì•¼ì™¸í™œë™"
                    >
                      ì•¼ì™¸í™œë™
                    </div>
                    <div
                      class="preference-tag"
                      data-type="travel_style"
                      data-value="ë ˆì €Â·ì•¡í‹°ë¹„í‹°"
                    >
                      ë ˆì €Â·ì•¡í‹°ë¹„í‹°
                    </div>
                    <div
                      class="preference-tag"
                      data-type="travel_style"
                      data-value="ë¬¸í™”Â·ì—­ì‚¬"
                    >
                      ë¬¸í™”Â·ì—­ì‚¬
                    </div>
                    <div
                      class="preference-tag"
                      data-type="travel_style"
                      data-value="ì¶•ì œÂ·ì´ë²¤íŠ¸"
                    >
                      ì¶•ì œÂ·ì´ë²¤íŠ¸
                    </div>
                    <div
                      class="preference-tag"
                      data-type="travel_style"
                      data-value="ë¨¹ê±°ë¦¬ íƒë°©"
                    >
                      ë¨¹ê±°ë¦¬ íƒë°©
                    </div>
                    <div
                      class="preference-tag"
                      data-type="travel_style"
                      data-value="ì‚¬ì§„ ìŠ¤íŒŸ"
                    >
                      ì‚¬ì§„ ìŠ¤íŒŸ
                    </div>
                  </div>
                </div>

                <!-- 3. ì¼ìë¦¬ ì„ í˜¸ë„ (6ê°œ) -->
                <div class="mb-4">
                  <h5>
                    <i class="fas fa-seedling text-warning me-2"></i>ì›í•˜ì‹œëŠ”
                    ì¼ìë¦¬ ì¢…ë¥˜ë¥¼ ì•Œë ¤ì£¼ì„¸ìš” (6ê°œ ì¤‘ ì„ íƒ)
                  </h5>
                  <div class="d-flex flex-wrap gap-2 mt-3">
                    <div
                      class="preference-tag"
                      data-type="job_type"
                      data-value="ì±„ì†Œ"
                    >
                      ì±„ì†Œ
                    </div>
                    <div
                      class="preference-tag"
                      data-type="job_type"
                      data-value="ê³¼ìˆ˜"
                    >
                      ê³¼ìˆ˜
                    </div>
                    <div
                      class="preference-tag"
                      data-type="job_type"
                      data-value="í™”í›¼"
                    >
                      í™”í›¼
                    </div>
                    <div
                      class="preference-tag"
                      data-type="job_type"
                      data-value="ì‹ëŸ‰ì‘ë¬¼"
                    >
                      ì‹ëŸ‰ì‘ë¬¼
                    </div>
                    <div
                      class="preference-tag"
                      data-type="job_type"
                      data-value="ì¶•ì‚°"
                    >
                      ì¶•ì‚°
                    </div>
                    <div
                      class="preference-tag"
                      data-type="job_type"
                      data-value="ë†ê¸°ê³„"
                    >
                      ë†ê¸°ê³„
                    </div>
                  </div>
                </div>

                <!-- 4. ì¶”ê°€ ìš”ì²­ì‚¬í•­ (ë‹¨ë‹µ í‚¤ì›Œë“œ 5ê°œ, ì„ íƒì‚¬í•­) -->
                <div class="mb-4">
                  <h5>
                    <i class="fas fa-comments text-primary me-2"></i>ì¶”ê°€
                    ìš”ì²­ì‚¬í•­ (ì„ íƒì‚¬í•­, ìµœëŒ€ 5ê°œ)
                  </h5>
                  <p class="text-muted small">
                    ë‹¨ë‹µ í‚¤ì›Œë“œë¡œ ì…ë ¥í•˜ì„¸ìš”. ì…ë ¥í•˜ì§€ ì•Šì•„ë„ ë©ë‹ˆë‹¤.
                  </p>
                  <div class="row">
                    <div class="col-md-6 mb-2">
                      <input
                        type="text"
                        class="form-control"
                        id="natural1"
                        placeholder="ì˜ˆ: ëšœë²…ì´ ì—¬í–‰"
                      />
                    </div>
                    <div class="col-md-6 mb-2">
                      <input
                        type="text"
                        class="form-control"
                        id="natural2"
                        placeholder="ì˜ˆ: ìì—° ì‚°ì±…"
                      />
                    </div>
                    <div class="col-md-6 mb-2">
                      <input
                        type="text"
                        class="form-control"
                        id="natural3"
                        placeholder="ì˜ˆ: ì‹œì¥íˆ¬ì–´"
                      />
                    </div>
                    <div class="col-md-6 mb-2">
                      <input
                        type="text"
                        class="form-control"
                        id="natural4"
                        placeholder="ì˜ˆ: ìˆ¨ê²¨ì§„ ë§›ì§‘"
                      />
                    </div>
                    <div class="col-12 mb-2">
                      <input
                        type="text"
                        class="form-control"
                        id="natural5"
                        placeholder="ì˜ˆ: ë¹µ, ë””ì €íŠ¸ íˆ¬ì–´"
                      />
                    </div>
                  </div>
                </div>

                <!-- ë‹¤ìŒ ë‹¨ê³„ ë²„íŠ¼ -->
                <div class="text-center">
                  <button class="btn btn-primary btn-lg" onclick="goToStep2()">
                    <i class="fas fa-arrow-right me-2"></i>ìì—°ì–´ ìš”ì²­ ì…ë ¥í•˜ê¸°
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Step 2: ìì—°ì–´ ìš”ì²­ ì…ë ¥ -->
      <div id="natural-input-section" class="mb-5" style="display: none">
        <div class="row justify-content-center">
          <div class="col-md-8">
            <div class="card">
              <div class="card-header">
                <h3>
                  <i class="fas fa-comments text-primary me-2"></i>ìì—°ì–´ ì—¬í–‰
                  ìš”ì²­
                </h3>
              </div>
              <div class="card-body">
                <div class="mb-3">
                  <label class="form-label"
                    >ì–¸ì œ, ì–´ë””ì„œ, ë¬´ì—‡ì„ í•˜ê³  ì‹¶ìœ¼ì‹ ê°€ìš”?</label
                  >
                  <textarea
                    class="form-control"
                    id="naturalQuery"
                    rows="4"
                    placeholder="ì˜ˆì‹œ: 10ì›” ì´ˆì— ì—´í˜ ì •ë„ ì „ë¶ ê¹€ì œì—ì„œ ê³¼ìˆ˜ì› ì²´í—˜í•˜ë©´ì„œ íë§í•˜ê³  ì‹¶ì–´. ì¶•ì œë„ ìˆìœ¼ë©´ ê°€ë³´ê³  ì‹¶ì–´."
                  ></textarea>
                </div>
                <div class="text-center">
                  <button
                    class="btn btn-success btn-lg"
                    onclick="searchRecommendations()"
                  >
                    <i class="fas fa-search me-2"></i>ì¶”ì²œ ë°›ê¸°
                  </button>
                  <button
                    class="btn btn-outline-secondary ms-2"
                    onclick="loadExample()"
                  >
                    ì˜ˆì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Loading -->
      <div class="loading" id="loading">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-3">ì¶”ì²œ ê²°ê³¼ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘...</p>
      </div>

      <!-- Step 2: ì¶”ì²œ ê²°ê³¼ -->
      <div id="results-section" class="mb-5" style="display: none">
        <div class="row">
          <!-- ë†ê°€ ì¶”ì²œ -->
          <div class="col-md-6">
            <h3>
              <i class="fas fa-tractor text-success me-2"></i>ì¶”ì²œ ë†ê°€ (5ê°œ,
              1ê°œë§Œ ì„ íƒ)
            </h3>
            <div id="jobCards"></div>
          </div>

          <!-- ê´€ê´‘ì§€ ì¶”ì²œ -->
          <div class="col-md-6">
            <h3>
              <i class="fas fa-map-marked-alt text-info me-2"></i>ì¶”ì²œ ê´€ê´‘ì§€
              (5ê°œ, ì›í•˜ëŠ” ë§Œí¼ ì„ íƒ)
            </h3>
            <div id="tourCards"></div>
          </div>
        </div>

        <div class="text-center mt-4">
          <button
            class="btn btn-success btn-lg"
            onclick="goToStep3()"
            id="generateBtn"
            disabled
          >
            <i class="fas fa-calendar me-2"></i>ì„ íƒí•œ ì¹´ë“œë¡œ ì¼ì • ìƒì„±
          </button>
        </div>
      </div>

      <!-- Step 3: ì¼ì • ìƒì„± ê²°ê³¼ -->
      <div id="itinerary-section" class="mb-5" style="display: none">
        <h3>
          <i class="fas fa-calendar-alt text-primary me-2"></i>ìƒì„±ëœ ë§ì¶¤í˜•
          ì¼ì •
        </h3>
        <div id="itineraryResult"></div>

        <!-- ìˆ™ë°• ì¶”ì²œ ì„¹ì…˜ -->
        <div class="mt-5" id="accommodationSection" style="display: none">
          <h4>
            <i class="fas fa-bed text-info me-2"></i>ì¶”ì²œ ìˆ™ë°•ì‹œì„¤ (í•´ë‹¹ ì§€ì—­)
          </h4>
          <div class="row" id="accommodationCards"></div>
        </div>

        <!-- ìŒì‹ì  ì¶”ì²œ ì„¹ì…˜ -->
        <div class="mt-4" id="restaurantSection" style="display: none">
          <h4>
            <i class="fas fa-utensils text-success me-2"></i>ì¶”ì²œ ìŒì‹ì  (í•´ë‹¹
            ì§€ì—­)
          </h4>
          <div class="row" id="restaurantCards"></div>
        </div>

        <!-- í”¼ë“œë°± ì„¹ì…˜ -->
        <div class="mt-4">
          <h4><i class="fas fa-comment text-warning me-2"></i>ì¼ì • í”¼ë“œë°±</h4>
          <div class="mb-3">
            <textarea
              class="form-control"
              id="feedback"
              rows="3"
              placeholder="ì¼ì • ìˆ˜ì • ìš”ì²­ì‚¬í•­ì„ ìì—°ì–´ë¡œ ì…ë ¥í•˜ì„¸ìš”"
            ></textarea>
          </div>
          <button
            class="btn btn-warning"
            onclick="submitFeedback()"
            id="feedbackBtn"
          >
            í”¼ë“œë°± ì œì¶œ
          </button>
        </div>
      </div>
    </div>

    <script>
      // ì „ì—­ ë³€ìˆ˜
      let selectedPreferences = {
        landscape_keywords: [],
        travel_style_keywords: [],
        job_type_keywords: [],
        simple_natural_words: [],
      };
      let selectedFarm = null;
      let selectedTours = [];
      let currentItineraryId = null;

      // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
      document.addEventListener("DOMContentLoaded", function () {
        // ì„ í˜¸ë„ íƒœê·¸ í´ë¦­ ì´ë²¤íŠ¸
        document.querySelectorAll(".preference-tag").forEach((tag) => {
          tag.addEventListener("click", function () {
            this.classList.toggle("selected");
          });
        });

        // ì˜ˆì‹œ ë°ì´í„° ìë™ ë¡œë“œ
        setTimeout(() => {
          loadExample();
        }, 500);
      });

      // ì˜ˆì‹œ ë°ì´í„° ë¡œë“œ
      function loadExample() {
        // ì„ í˜¸ë„ ì„ íƒ í•´ì œ
        document.querySelectorAll(".preference-tag.selected").forEach((tag) => {
          tag.classList.remove("selected");
        });

        // ì˜ˆì‹œ ì„ í˜¸ë„ ì„¤ì •
        document
          .querySelector('[data-type="landscape"][data-value="ì‚°"]')
          .classList.add("selected");
        document
          .querySelector('[data-type="landscape"][data-value="ìˆ²"]')
          .classList.add("selected");
        document
          .querySelector('[data-type="travel_style"][data-value="ì¶•ì œÂ·ì´ë²¤íŠ¸"]')
          .classList.add("selected");
        document
          .querySelector('[data-type="travel_style"][data-value="íë§Â·ì—¬ìœ "]')
          .classList.add("selected");
        document
          .querySelector('[data-type="job_type"][data-value="ê³¼ìˆ˜"]')
          .classList.add("selected");

        // ì¶”ê°€ ìš”ì²­ì‚¬í•­ ì˜ˆì‹œ
        document.getElementById("natural1").value = "ëšœë²…ì´ ì—¬í–‰";
        document.getElementById("natural2").value = "ìì—° ì‚°ì±…";

        // ìì—°ì–´ ìš”ì²­ ì˜ˆì‹œ
        document.getElementById("naturalQuery").value =
          "10ì›” ì´ˆì— ì—´í˜ ì •ë„ ì „ë¶ ê¹€ì œì—ì„œ ê³¼ìˆ˜ì› ì²´í—˜í•˜ë©´ì„œ íë§í•˜ê³  ì‹¶ì–´. ì¶•ì œë„ ìˆìœ¼ë©´ ê°€ë³´ê³  ì‹¶ì–´.";
      }

      // Step 2ë¡œ ì´ë™
      function goToStep2() {
        // ì„ í˜¸ë„ ìˆ˜ì§‘
        selectedPreferences.landscape_keywords = Array.from(
          document.querySelectorAll('[data-type="landscape"].selected')
        ).map((el) => el.dataset.value);
        selectedPreferences.travel_style_keywords = Array.from(
          document.querySelectorAll('[data-type="travel_style"].selected')
        ).map((el) => el.dataset.value);
        selectedPreferences.job_type_keywords = Array.from(
          document.querySelectorAll('[data-type="job_type"].selected')
        ).map((el) => el.dataset.value);

        // ì¶”ê°€ ìš”ì²­ì‚¬í•­ 5ê°œ ì¹¸ì—ì„œ ìˆ˜ì§‘ (ë¹ˆ ê°’ì€ ì œì™¸)
        const additionalRequests = [
          document.getElementById("natural1").value.trim(),
          document.getElementById("natural2").value.trim(),
          document.getElementById("natural3").value.trim(),
          document.getElementById("natural4").value.trim(),
          document.getElementById("natural5").value.trim(),
        ].filter((req) => req !== "");
        selectedPreferences.simple_natural_words = additionalRequests;

        // í™”ë©´ ì „í™˜
        document.getElementById("preference-section").style.display = "none";
        document.getElementById("natural-input-section").style.display =
          "block";
        document
          .getElementById("step1")
          .classList.replace("active", "completed");
        document.getElementById("step2").classList.add("active");
      }

      // ì¶”ì²œ ê²€ìƒ‰
      async function searchRecommendations() {
        const naturalRequest = document
          .getElementById("naturalQuery")
          .value.trim();

        if (!naturalRequest) {
          alert("ìì—°ì–´ ìš”ì²­ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
          return;
        }

        // System_Improvements.md: ì„ í˜¸ë„ í‚¤ì›Œë“œì™€ ìì—°ì–´ ìš”ì²­ì„ ì„œë²„ì—ì„œ ê²°í•©

        // ë¡œë”© í‘œì‹œ
        document.getElementById("natural-input-section").style.display = "none";
        document.getElementById("loading").style.display = "block";

        try {
          const response = await fetch("/recommendations", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              natural_request: naturalRequest,
              preferences: selectedPreferences,
            }),
          });

          const result = await response.json();
          document.getElementById("loading").style.display = "none";

          if (result.status === "success") {
            displayRecommendations({
              farms: result.data.farms || [],
              tour_spots: result.data.tour_spots || [],
            });
            console.log("ì¶”ì²œ ê²°ê³¼:", result);
          } else {
            alert("ì˜¤ë¥˜: " + (result.message || "API í˜¸ì¶œ ì‹¤íŒ¨"));
          }
        } catch (error) {
          document.getElementById("loading").style.display = "none";
          alert("ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: " + error.message);
        }
      }

      // ì¶”ì²œ ê²°ê³¼ í‘œì‹œ
      function displayRecommendations(data) {
        // ë†ê°€ ì¹´ë“œ í‘œì‹œ (ìš”êµ¬ì‚¬í•­: photo, farm, title, address, start_time, end_time)
        const jobCardsHtml = data.farms
          .map(
            (farm, index) => `
                <div class="card card-hover mb-3" onclick="selectFarm(${index})">
                    ${
                      farm.photo
                        ? `<img src="${farm.photo}" class="card-img-top" style="height: 200px; object-fit: cover;" alt="${farm.farm}">`
                        : ""
                    }
                    <div class="card-body">
                        <h5 class="card-title">${farm.farm}</h5>
                        <h6 class="card-subtitle mb-2 text-muted">${
                          farm.title
                        }</h6>
                        <p class="card-text">
                            ğŸ“ ${farm.address}<br>
                            â° ${farm.start_time} - ${farm.end_time}
                            ${farm.tag ? `<br>ğŸ·ï¸ ${farm.tag}` : ""}
                            ${
                              farm.required_people
                                ? `<br>ğŸ‘¥ ${farm.required_people}ëª…`
                                : ""
                            }
                        </p>
                    </div>
                </div>
            `
          )
          .join("");
        document.getElementById("jobCards").innerHTML = jobCardsHtml;

        // ê´€ê´‘ì§€ ì¹´ë“œ í‘œì‹œ (ìš”êµ¬ì‚¬í•­: photo, name, address, overview)
        const tourCardsHtml = data.tour_spots
          .map(
            (spot, index) => `
                <div class="card card-hover mb-3" onclick="selectTour(${index})">
                    ${
                      spot.photo
                        ? `<img src="${spot.photo}" class="card-img-top" style="height: 200px; object-fit: cover;" alt="${spot.name}">`
                        : ""
                    }
                    <div class="card-body">
                        <h5 class="card-title">${spot.name}</h5>
                        <p class="card-text">
                            ğŸ“ ${spot.address}
                            ${
                              spot.overview
                                ? `<br><small class="text-muted">${spot.overview}</small>`
                                : ""
                            }
                        </p>
                    </div>
                </div>
            `
          )
          .join("");
        document.getElementById("tourCards").innerHTML = tourCardsHtml;

        // ë°ì´í„° ì €ì¥
        window.currentRecommendations = data;

        // í™”ë©´ ì „í™˜
        document.getElementById("results-section").style.display = "block";
        document
          .getElementById("step2")
          .classList.replace("active", "completed");
        document.getElementById("step3").classList.add("active");
      }

      // ë†ê°€ ì„ íƒ (1ê°œë§Œ)
      function selectFarm(index) {
        // ê¸°ì¡´ ì„ íƒ í•´ì œ
        document.querySelectorAll("#jobCards .card").forEach((card) => {
          card.classList.remove("selected");
        });

        // ìƒˆë¡œ ì„ íƒ
        document
          .querySelectorAll("#jobCards .card")
          [index].classList.add("selected");
        selectedFarm = window.currentRecommendations.farms[index];

        updateGenerateButton();
      }

      // ê´€ê´‘ì§€ ì„ íƒ (ì—¬ëŸ¬ ê°œ)
      function selectTour(index) {
        const card = document.querySelectorAll("#tourCards .card")[index];
        const tour = window.currentRecommendations.tour_spots[index];

        if (card.classList.contains("selected")) {
          card.classList.remove("selected");
          selectedTours = selectedTours.filter(
            (t) => t.tour_id !== tour.tour_id
          );
        } else {
          card.classList.add("selected");
          selectedTours.push(tour);
        }

        updateGenerateButton();
      }

      // ì¼ì • ìƒì„± ë²„íŠ¼ í™œì„±í™” ì²´í¬
      function updateGenerateButton() {
        const btn = document.getElementById("generateBtn");
        btn.disabled = !selectedFarm || selectedTours.length === 0;
      }

      // Step 3ë¡œ ì´ë™ (ì¼ì • ìƒì„±)
      async function goToStep3() {
        if (!selectedFarm || selectedTours.length === 0) {
          alert("ë†ê°€ 1ê°œì™€ ê´€ê´‘ì§€ 1ê°œ ì´ìƒì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
          return;
        }

        try {
          const response = await fetch("/api/schedule", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              natural_request: document.getElementById("naturalQuery").value,
              selected_farm: selectedFarm,
              selected_tours: selectedTours,
              preferences: selectedPreferences,
            }),
          });

          const result = await response.json();

          if (result.status === "success") {
            currentItineraryId = result.data.itinerary_id;
            displayItinerary(result.data);
          } else {
            alert("ì˜¤ë¥˜: " + (result.message || "API í˜¸ì¶œ ì‹¤íŒ¨"));
          }
        } catch (error) {
          alert("ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: " + error.message);
        }
      }

      // ì¼ì • ê²°ê³¼ í‘œì‹œ
      function displayItinerary(data) {
        const itineraryContent =
          data.schedule_text ||
          data.natural_language_itinerary ||
          "ì¼ì • ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";

        document.getElementById("itineraryResult").innerHTML = `
                <div class="alert alert-success">
                    âœ… ${
                      data.days || data.total_days || "?"
                    }ì¼ ë§ì¶¤í˜• ì¼ì •ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤! ${
          data.region ? `(${data.region} ì§€ì—­)` : ""
        } (ID: ${data.itinerary_id || "N/A"})
                </div>
                <div class="card">
                    <div class="card-body">
                        <div style="white-space: pre-wrap; line-height: 1.6;">${itineraryContent}</div>
                    </div>
                </div>
            `;

        // ìˆ™ë°•ì‹œì„¤ ì¹´ë“œ í‘œì‹œ
        if (data.accommodations && data.accommodations.length > 0) {
          displayAccommodationCards(data.accommodations);
          document.getElementById("accommodationSection").style.display =
            "block";
        }

        // ìŒì‹ì  ì¹´ë“œ í‘œì‹œ
        if (data.restaurants && data.restaurants.length > 0) {
          displayRestaurantCards(data.restaurants);
          document.getElementById("restaurantSection").style.display = "block";
        }

        document.getElementById("itinerary-section").style.display = "block";
        document.getElementById("results-section").style.display = "none";
      }

      // ìˆ™ë°•ì‹œì„¤ ì¹´ë“œ í‘œì‹œ
      function displayAccommodationCards(accommodations) {
        const cardsHtml = accommodations
          .map(
            (acc) => `
                <div class="col-md-4 mb-3">
                    <div class="card h-100">
                        ${
                          acc.photo
                            ? `<img src="${acc.photo}" class="card-img-top" style="height: 200px; object-fit: cover;" alt="${acc.name}">`
                            : '<div class="card-img-top bg-light d-flex align-items-center justify-content-center" style="height: 200px;"><i class="fas fa-bed fa-3x text-muted"></i></div>'
                        }
                        <div class="card-body">
                            <h6 class="card-title">${acc.name}</h6>
                            <p class="card-text small">ğŸ“ ${acc.address}</p>
                        </div>
                    </div>
                </div>
            `
          )
          .join("");
        document.getElementById("accommodationCards").innerHTML = cardsHtml;
      }

      // ìŒì‹ì  ì¹´ë“œ í‘œì‹œ
      function displayRestaurantCards(restaurants) {
        const cardsHtml = restaurants
          .map(
            (rest) => `
                <div class="col-md-4 mb-3">
                    <div class="card h-100">
                        ${
                          rest.photo
                            ? `<img src="${rest.photo}" class="card-img-top" style="height: 200px; object-fit: cover;" alt="${rest.name}">`
                            : '<div class="card-img-top bg-light d-flex align-items-center justify-content-center" style="height: 200px;"><i class="fas fa-utensils fa-3x text-muted"></i></div>'
                        }
                        <div class="card-body">
                            <h6 class="card-title">${rest.name}</h6>
                            <p class="card-text small">ğŸ“ ${rest.address}</p>
                        </div>
                    </div>
                </div>
            `
          )
          .join("");
        document.getElementById("restaurantCards").innerHTML = cardsHtml;
      }

      // í”¼ë“œë°± ì œì¶œ
      async function submitFeedback() {
        const feedback = document.getElementById("feedback").value.trim();

        if (!feedback) {
          alert("í”¼ë“œë°± ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
          return;
        }

        try {
          const response = await fetch("/api/schedule/feedback", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              itinerary_id: currentItineraryId,
              feedback: feedback,
            }),
          });

          const result = await response.json();

          if (result.status === "success") {
            displayFeedbackResult(result.data);
          } else {
            alert("ì˜¤ë¥˜: " + (result.message || "API í˜¸ì¶œ ì‹¤íŒ¨"));
          }
        } catch (error) {
          alert("ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: " + error.message);
        }
      }

      // í”¼ë“œë°± ê²°ê³¼ í‘œì‹œ
      function displayFeedbackResult(data) {
        const changesHtml = (data.changes_summary || [])
          .map((change) => `<li>${change}</li>`)
          .join("");
        const itineraryContent =
          data.schedule_text ||
          data.updated_itinerary ||
          data.natural_language_itinerary ||
          "ì¼ì •ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";

        document.getElementById("itineraryResult").innerHTML = `
                <div class="alert alert-success">
                    âœ… í”¼ë“œë°±ì´ ë°˜ì˜ë˜ì–´ ì¼ì •ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!
                </div>
                ${
                  changesHtml
                    ? `<div class="alert alert-info">
                    <h5>ìˆ˜ì •ì‚¬í•­:</h5>
                    <ul>${changesHtml}</ul>
                </div>`
                    : ""
                }
                <div class="card">
                    <div class="card-body">
                        <h5>ìˆ˜ì •ëœ ì¼ì •:</h5>
                        <div style="white-space: pre-wrap; line-height: 1.6;">${itineraryContent}</div>
                    </div>
                </div>
            `;
      }
    </script>
  </body>
</html>
