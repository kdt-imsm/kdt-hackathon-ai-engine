#!/usr/bin/env python3
"""
scripts/bulk_keyword_processor.py
==================================

ì „ì²´ tour_api.csv ë°ì´í„°ì— ëŒ€í•œ ë¹ ë¥¸ í‚¤ì›Œë“œ ì²˜ë¦¬ ìŠ¤í¬ë¦½íŠ¸

íŒ¨í„´ ê¸°ë°˜ í‚¤ì›Œë“œ ì¶”ì¶œê³¼ ì§€ëª… ë¶„ì„ì„ í†µí•´ API í˜¸ì¶œ ì—†ì´ë„
ì˜ë¯¸ìˆëŠ” í‚¤ì›Œë“œë¥¼ ëŒ€ëŸ‰ ìƒì„±í•©ë‹ˆë‹¤.

ì‚¬ìš©ë²•:
python -m scripts.bulk_keyword_processor
"""

import pandas as pd
import re
from pathlib import Path
from typing import List, Set
import json

class BulkKeywordProcessor:
    def __init__(self):
        # ì§€ì—­ë³„ íŠ¹ì§• í‚¤ì›Œë“œ
        self.region_keywords = {
            'ì œì£¼': ['í™”ì‚°', 'ëŒë‹´', 'ì˜¤ë¦„', 'ë°”ëŒ', 'ê°ê·¤', 'í•œë¼ì‚°'],
            'ë¶€ì‚°': ['ë°”ë‹¤', 'í•´ë³€', 'í•­êµ¬', 'ìˆ˜ì˜', 'í•´ìš´ëŒ€', 'ê´‘ì•ˆë¦¬'],
            'ê²½ë‚¨': ['ë°”ë‹¤', 'í•´ì•ˆ', 'ì‚°', 'ì—­ì‚¬', 'ì „í†µ'],
            'ì „ë‚¨': ['ê°¯ë²Œ', 'ë°”ë‹¤', 'ì„¬', 'í•´ì•ˆ', 'ì „í†µ', 'ìì—°'],
            'ê°•ì›': ['ì‚°', 'ì„¤ì•…ì‚°', 'ìŠ¤í‚¤', 'ì˜¨ì²œ', 'ê³„ê³¡', 'ìì—°'],
            'ê²½ë¶': ['ì‚°', 'ì‚¬ì°°', 'ì—­ì‚¬', 'ë¬¸í™”', 'ê²½ì£¼', 'ì „í†µ'],
            'ì¶©ë¶': ['í˜¸ìˆ˜', 'ì‚°', 'ì˜¨ì²œ', 'ìì—°', 'íœ´ì–‘'],
            'ì¶©ë‚¨': ['ë°”ë‹¤', 'ì˜¨ì²œ', 'ì—­ì‚¬', 'ë¬¸í™”', 'ìì—°'],
            'ì „ë¶': ['ìì—°', 'ì‚°', 'ì „í†µ', 'ë¬¸í™”', 'ìŒì‹'],
            'ê²½ê¸°': ['ìì—°', 'ê³µì›', 'ë¬¸í™”', 'ì—­ì‚¬', 'íœ´ì–‘'],
            'ì„œìš¸': ['ë¬¸í™”', 'ì—­ì‚¬', 'ê³µì›', 'ë„ì‹¬', 'í•œê°•'],
            'ì¸ì²œ': ['ë°”ë‹¤', 'ê³µí•­', 'ì„¬', 'í•´ì•ˆ', 'êµ­ì œ'],
            'ëŒ€êµ¬': ['ë¬¸í™”', 'ì—­ì‚¬', 'ë„ì‹¬', 'ì‚°'],
            'ëŒ€ì „': ['ê³¼í•™', 'ë¬¸í™”', 'ë„ì‹¬', 'ê³µì›'],
            'ìš¸ì‚°': ['ê³µì—…', 'ë°”ë‹¤', 'í•´ì•ˆ', 'í˜„ëŒ€'],
            'ê´‘ì£¼': ['ë¬¸í™”', 'ì˜ˆìˆ ', 'ì—­ì‚¬', 'ë¬´ë“±ì‚°'],
            'ì„¸ì¢…': ['ë„ì‹œ', 'ê³µì›', 'í˜„ëŒ€', 'ê³„íšë„ì‹œ']
        }
        
        # ê´€ê´‘ì§€ ìœ í˜•ë³„ í‚¤ì›Œë“œ ë§¤í•‘
        self.attraction_patterns = {
            # ìì—° ê´€ê´‘ì§€
            'í•´ìˆ˜ìš•ì¥|í•´ë³€|ë¹„ì¹˜': ['ë°”ë‹¤', 'í•´ë³€', 'ë¬¼ë†€ì´', 'ì—¬ë¦„', 'í•´ìˆ˜ìš•', 'ëª¨ë˜'],
            'ì˜¨ì²œ|ìŠ¤íŒŒ': ['ì˜¨ì²œ', 'íë§', 'íœ´ì–‘', 'ì¹˜ìœ ', 'ì˜¨ìˆ˜'],
            'ê³„ê³¡': ['ê³„ê³¡', 'ë¬¼', 'ìì—°', 'ì—¬ë¦„', 'í”¼ì„œ', 'ì²­ëŸ‰'],
            'í­í¬': ['í­í¬', 'ìì—°', 'ë¬¼', 'ê²½ê´€', 'ì‹œì›í•¨'],
            'ì‚°|ë´‰': ['ì‚°', 'ë“±ì‚°', 'í•˜ì´í‚¹', 'ìì—°', 'ìš´ë™', 'ê²½ì¹˜'],
            'í˜¸ìˆ˜|ì €ìˆ˜ì§€': ['í˜¸ìˆ˜', 'ë¬¼', 'ìì—°', 'íœ´ì‹', 'ê²½ê´€'],
            'ê³µì›': ['ê³µì›', 'ìì—°', 'ì‚°ì±…', 'íœ´ì‹', 'ë…¹ì§€', 'ìš´ë™'],
            'ìˆ˜ëª©ì›|ì‹ë¬¼ì›': ['ì‹ë¬¼', 'ìì—°', 'êµìœ¡', 'ì‚°ì±…', 'íë§'],
            'ê°¯ë²Œ': ['ê°¯ë²Œ', 'ì¡°ê°œ', 'ë°”ë‹¤', 'ìƒíƒœ', 'ì²´í—˜'],
            
            # ë¬¸í™”/ì—­ì‚¬ ê´€ê´‘ì§€
            'ì‚¬ì°°|ì ˆ': ['ì‚¬ì°°', 'ë¶ˆêµ', 'ë¬¸í™”', 'ì—­ì‚¬', 'ì „í†µ', 'ì¢…êµ'],
            'ë°•ë¬¼ê´€': ['ë°•ë¬¼ê´€', 'ë¬¸í™”', 'êµìœ¡', 'ì—­ì‚¬', 'ì „ì‹œ'],
            'ë¯¸ìˆ ê´€': ['ë¯¸ìˆ ê´€', 'ì˜ˆìˆ ', 'ë¬¸í™”', 'ì „ì‹œ', 'ì‘í’ˆ'],
            'ê¶|ê¶ê¶': ['ê¶ê¶', 'ì—­ì‚¬', 'ì¡°ì„ ', 'ë¬¸í™”ì¬', 'ì „í†µ'],
            'ì„±|ì„±ê³½': ['ì„±', 'ì—­ì‚¬', 'ë¬¸í™”ì¬', 'ì „í†µ', 'ë°©ì–´'],
            'ì„œì›|í–¥êµ': ['ì„œì›', 'êµìœ¡', 'ìœ êµ', 'ì—­ì‚¬', 'ì „í†µ'],
            'ìœ ì ì§€|ìœ ì ': ['ìœ ì ', 'ì—­ì‚¬', 'ê³ ê³ í•™', 'ë¬¸í™”ì¬', 'ë°œêµ´'],
            'ë¬¸í™”ì¬': ['ë¬¸í™”ì¬', 'ì—­ì‚¬', 'ì „í†µ', 'ë³´ì¡´', 'ë¬¸í™”'],
            'ì „í†µë§ˆì„|í•œì˜¥ë§ˆì„': ['ì „í†µë§ˆì„', 'í•œì˜¥', 'ë¬¸í™”', 'ì—­ì‚¬', 'ì „í†µ'],
            'ë²½í™”ë§ˆì„': ['ë²½í™”', 'ë§ˆì„', 'ì˜ˆìˆ ', 'ë¬¸í™”', 'ì²´í—˜'],
            
            # ë ˆì €/ì²´í—˜ ê´€ê´‘ì§€
            'ìŠ¤í‚¤ì¥': ['ìŠ¤í‚¤', 'ê²¨ìš¸ìŠ¤í¬ì¸ ', 'ëˆˆ', 'ë ˆì €', 'ìŠ¤ë…¸ë³´ë“œ'],
            'ê³¨í”„ì¥': ['ê³¨í”„', 'ë ˆì €', 'ìŠ¤í¬ì¸ ', 'ìš´ë™', 'ì—¬ê°€'],
            'ë†€ì´ê³µì›|í…Œë§ˆíŒŒí¬': ['ë†€ì´ê³µì›', 'ê°€ì¡±', 'ì¬ë¯¸', 'ì—”í„°í…Œì¸ë¨¼íŠ¸', 'ì²´í—˜'],
            'ë™ë¬¼ì›': ['ë™ë¬¼ì›', 'ë™ë¬¼', 'ê°€ì¡±', 'êµìœ¡', 'ì²´í—˜'],
            'ìˆ˜ì¡±ê´€': ['ìˆ˜ì¡±ê´€', 'ë°”ë‹¤ìƒë¬¼', 'êµìœ¡', 'ì²´í—˜', 'ê°€ì¡±'],
            'ì²´í—˜ì¥|ì²´í—˜': ['ì²´í—˜', 'êµìœ¡', 'í™œë™', 'ì°¸ì—¬', 'í•™ìŠµ'],
            
            # íŠ¹ìˆ˜ ê´€ê´‘ì§€
            'ì „ë§ëŒ€|ì¡°ë§': ['ì „ë§ëŒ€', 'ê²½ì¹˜', 'ì¡°ë§', 'í’ê²½', 'ê²½ê´€'],
            'ë“±ëŒ€': ['ë“±ëŒ€', 'ë°”ë‹¤', 'í•´ì•ˆ', 'í•­í•´', 'ì—­ì‚¬'],
            'ë‹¤ë¦¬|êµ': ['ë‹¤ë¦¬', 'ê±´ì¶•', 'ê²½ê´€', 'ë„ì‹œ', 'êµí†µ'],
            'ì‹œì¥': ['ì‹œì¥', 'ìŒì‹', 'ì‡¼í•‘', 'ì „í†µ', 'ë¬¸í™”'],
            'í„°ë¯¸ë„|ì—­': ['êµí†µ', 'ì—¬í–‰', 'ì¶œë°œì ', 'ì—°ê²°'],
        }
    
    def extract_region_short_name(self, region: str) -> str:
        """ì§€ì—­ëª…ì—ì„œ í•µì‹¬ í‚¤ì›Œë“œ ì¶”ì¶œ"""
        # ê´‘ì—­ì‹œ/ë„ íŒ¨í„´ ì œê±°í•˜ê³  í•µì‹¬ ì§€ëª…ë§Œ ì¶”ì¶œ
        region_clean = re.sub(r'(íŠ¹ë³„ì‹œ|ê´‘ì—­ì‹œ|íŠ¹ë³„ìì¹˜ì‹œ|íŠ¹ë³„ìì¹˜ë„|ë„)$', '', region.strip())
        
        # ì£¼ìš” ì§€ì—­ë³„ ë§¤í•‘
        region_mapping = {
            'ì„œìš¸': 'ì„œìš¸',
            'ë¶€ì‚°': 'ë¶€ì‚°', 
            'ëŒ€êµ¬': 'ëŒ€êµ¬',
            'ì¸ì²œ': 'ì¸ì²œ',
            'ê´‘ì£¼': 'ê´‘ì£¼',
            'ëŒ€ì „': 'ëŒ€ì „',
            'ìš¸ì‚°': 'ìš¸ì‚°',
            'ì„¸ì¢…': 'ì„¸ì¢…',
            'ê²½ê¸°': 'ê²½ê¸°',
            'ê°•ì›': 'ê°•ì›',
            'ì¶©ë¶': 'ì¶©ë¶',
            'ì¶©ë‚¨': 'ì¶©ë‚¨',
            'ì „ë¶': 'ì „ë¶',
            'ì „ë‚¨': 'ì „ë‚¨',
            'ê²½ë¶': 'ê²½ë¶',
            'ê²½ë‚¨': 'ê²½ë‚¨',
            'ì œì£¼': 'ì œì£¼'
        }
        
        for full_name, short_name in region_mapping.items():
            if full_name in region_clean:
                return short_name
        
        return region_clean[:2]  # ì²˜ìŒ 2ê¸€ì ë°˜í™˜
    
    def extract_attraction_keywords(self, name: str) -> List[str]:
        """ê´€ê´‘ì§€ëª…ì—ì„œ íŒ¨í„´ ê¸°ë°˜ í‚¤ì›Œë“œ ì¶”ì¶œ"""
        keywords = []
        name_lower = name.lower()
        
        for pattern, pattern_keywords in self.attraction_patterns.items():
            if re.search(pattern, name):
                keywords.extend(pattern_keywords)
        
        # ê´€ê´‘ì§€ëª…ì—ì„œ ì§ì ‘ì ì¸ í‚¤ì›Œë“œ ì¶”ì¶œ
        name_keywords = self._extract_direct_keywords(name)
        keywords.extend(name_keywords)
        
        # ì¤‘ë³µ ì œê±° ë° ì •ë ¬
        unique_keywords = list(dict.fromkeys(keywords))
        return unique_keywords[:12]  # ìµœëŒ€ 12ê°œ
    
    def _extract_direct_keywords(self, name: str) -> List[str]:
        """ê´€ê´‘ì§€ëª…ì—ì„œ ì§ì ‘ì ì¸ ëª…ì‚¬ í‚¤ì›Œë“œ ì¶”ì¶œ"""
        keywords = []
        
        # ìì£¼ ë‚˜ì˜¤ëŠ” ê´€ê´‘ ê´€ë ¨ ë‹¨ì–´ë“¤
        tourism_words = [
            'ë°”ë‹¤', 'ì‚°', 'ê°•', 'í˜¸ìˆ˜', 'ê³„ê³¡', 'í­í¬', 'ì˜¨ì²œ', 'í•´ë³€', 'ì„¬',
            'ê³µì›', 'ìˆ²', 'ì •ì›', 'í•´ì•ˆ', 'ê°¯ë²Œ', 'ë™êµ´', 'ë´‰ìš°ë¦¬', 'ê³ ê°œ',
            'ì‚¬ì°°', 'ì ˆ', 'ê¶', 'ì„±', 'íƒ‘', 'ë¬¸', 'ë‹¤ë¦¬', 'ê±´ë¬¼', 'ì§‘',
            'ë°•ë¬¼ê´€', 'ë¯¸ìˆ ê´€', 'ì „ì‹œê´€', 'ì²´í—˜ê´€', 'ë¬¸í™”ì›', 'íšŒê´€',
            'ë§ˆì„', 'ë„ì‹œ', 'ê±°ë¦¬', 'ê´‘ì¥', 'ì‹œì¥', 'í„°ë¯¸ë„', 'ì—­',
            'ì¶•ì œ', 'í–‰ì‚¬', 'ê³µì—°', 'ì „ì‹œ', 'ì²´í—˜', 'íˆ¬ì–´', 'ì½”ìŠ¤'
        ]
        
        for word in tourism_words:
            if word in name:
                keywords.append(word)
        
        return keywords
    
    def process_bulk_keywords(self, input_file: str, output_file: str):
        """ì „ì²´ ë°ì´í„°ì— ëŒ€í•œ ë²Œí¬ í‚¤ì›Œë“œ ì²˜ë¦¬"""
        print(f"ğŸ“ {input_file} íŒŒì¼ ë¡œë”© ì¤‘...")
        df = pd.read_csv(input_file)
        
        print(f"ì´ {len(df)}ê°œì˜ ê´€ê´‘ì§€ ë°ì´í„° ì²˜ë¦¬ ì‹œì‘")
        
        # keywords ì»¬ëŸ¼ ì¶”ê°€
        if 'keywords' not in df.columns:
            df['keywords'] = ''
        
        processed = 0
        for idx, row in df.iterrows():
            name = row['name']
            region = row['region']
            tags = row.get('tags', 'ê´€ê´‘')
            
            # 1. ê´€ê´‘ì§€ëª… íŒ¨í„´ ê¸°ë°˜ í‚¤ì›Œë“œ ì¶”ì¶œ
            attraction_keywords = self.extract_attraction_keywords(name)
            
            # 2. ì§€ì—­ ê¸°ë°˜ í‚¤ì›Œë“œ ì¶”ê°€
            region_short = self.extract_region_short_name(region)
            region_keywords = self.region_keywords.get(region_short, ['ìì—°', 'ì—¬í–‰'])
            
            # 3. ê¸°ì¡´ íƒœê·¸ ë¶„í•´
            tag_keywords = [tag.strip() for tag in tags.split(',') if tag.strip()]
            
            # 4. ëª¨ë“  í‚¤ì›Œë“œ ê²°í•©
            all_keywords = attraction_keywords + region_keywords[:3] + tag_keywords
            
            # 5. ì¤‘ë³µ ì œê±° ë° ì •ë¦¬
            unique_keywords = list(dict.fromkeys(all_keywords))
            final_keywords = [kw for kw in unique_keywords if len(kw) >= 2][:15]
            
            # 6. DataFrame ì—…ë°ì´íŠ¸
            df.at[idx, 'keywords'] = ','.join(final_keywords)
            processed += 1
            
            # ì§„í–‰ìƒí™© ì¶œë ¥
            if processed % 1000 == 0:
                print(f"ğŸ”„ {processed:,}/{len(df):,} ì²˜ë¦¬ ì™„ë£Œ ({processed/len(df)*100:.1f}%)")
        
        # ê²°ê³¼ ì €ì¥
        print(f"ğŸ’¾ ê²°ê³¼ë¥¼ {output_file}ì— ì €ì¥ ì¤‘...")
        df.to_csv(output_file, index=False, encoding='utf-8-sig')
        
        print(f"âœ… ë²Œí¬ í‚¤ì›Œë“œ ì²˜ë¦¬ ì™„ë£Œ!")
        print(f"   - ì²˜ë¦¬ëœ ê´€ê´‘ì§€: {len(df):,}ê°œ")
        print(f"   - ì¶œë ¥ íŒŒì¼: {output_file}")
        
        # ìƒ˜í”Œ ê²°ê³¼ ì¶œë ¥
        print("\nğŸ“‹ ì²˜ë¦¬ ê²°ê³¼ ìƒ˜í”Œ:")
        for i in range(min(5, len(df))):
            row = df.iloc[i]
            print(f"  {i+1}. {row['name']} ({row['region']})")
            print(f"     í‚¤ì›Œë“œ: {row['keywords']}")
            print()

def main():
    processor = BulkKeywordProcessor()
    
    # ì „ì²´ ë°ì´í„° ì²˜ë¦¬
    processor.process_bulk_keywords(
        input_file="data/tour_api.csv",
        output_file="data/tour_api_with_keywords.csv"
    )

if __name__ == "__main__":
    main()