# ë²¡í„° ê¸°ë°˜ ì˜ë¯¸ì  ê²€ìƒ‰ ì‹œìŠ¤í…œ êµ¬í˜„ ì„¤ëª…

## ğŸ“‹ ê°œìš”

**"ì‚¬ìš©ìì˜ ìì—°ì–´ ì…ë ¥ì„ OpenAIì˜ text-embedding-3-smallë¡œ 1536ì°¨ì› ë²¡í„°ë¡œ ë³€í™˜í•˜ê³ , ë¯¸ë¦¬ ê³„ì‚°í•´ë‘” ê´€ê´‘ì§€ ë²¡í„°ë“¤ê³¼ ì½”ì‚¬ì¸ ìœ ì‚¬ë„ë¥¼ ë¹„êµí•´ì„œ ì˜ë¯¸ì ìœ¼ë¡œ ê°€ì¥ ìœ ì‚¬í•œ ê´€ê´‘ì§€ë¥¼ ì°¾ëŠ” ë°©ì‹"**ì„ ì™„ì „íˆ êµ¬í˜„í–ˆìŠµë‹ˆë‹¤.

## ğŸ—ï¸ ì•„í‚¤í…ì²˜ êµ¬ì„±

### 1. í•µì‹¬ ì»´í¬ë„ŒíŠ¸

```
advanced_features/
â”œâ”€â”€ vector_similarity_service.py      # ë²¡í„° ìœ ì‚¬ë„ ê²€ìƒ‰ ì—”ì§„
â”œâ”€â”€ vector_recommendation_engine.py   # ê°œì¸í™” ì¶”ì²œ ì—”ì§„
â”œâ”€â”€ embedding_service.py              # OpenAI ì„ë² ë”© ìƒì„±
â””â”€â”€ db/models.py                      # pgvector ì§€ì› DB ëª¨ë¸
```

### 2. ë°ì´í„° í”Œë¡œìš°

```mermaid
graph TD
    A[ì‚¬ìš©ì ìì—°ì–´ ì…ë ¥] --> B[OpenAI Embedding]
    B --> C[1536ì°¨ì› ë²¡í„° ìƒì„±]
    C --> D[PostgreSQL + pgvector]
    D --> E[ì½”ì‚¬ì¸ ìœ ì‚¬ë„ ê³„ì‚°]
    E --> F[ìœ ì‚¬ë„ ê¸°ì¤€ ì •ë ¬]
    F --> G[ì¶”ì²œ ê²°ê³¼ ë°˜í™˜]
```

## ğŸ”§ í•µì‹¬ êµ¬í˜„ ë°©ì‹

### 1. ë²¡í„°í™” ê³¼ì • (`embedding_service.py`)

**ì‚¬ìš©ì ì…ë ¥**: `"ê¹€ì œì—ì„œ ì‚¬ê³¼ë”°ê¸° ì²´í—˜í•˜ê³  ì‹¶ì–´"`

```python
def embed_text(text: str) -> List[float]:
    """ë‹¨ì¼ ë¬¸ì¥ì„ 1536ì°¨ì› ë²¡í„°ë¡œ ë³€í™˜"""
    resp = openai_client.embeddings.create(
        model="text-embedding-3-small",  # OpenAI ìµœì‹  ì„ë² ë”© ëª¨ë¸
        input=text,
    )
    return resp.data[0].embedding  # 1536ì°¨ì› float ë°°ì—´ ë°˜í™˜
```

**ê²°ê³¼**: `[0.123, -0.456, 0.789, ..., 0.321]` (1536ê°œ ì‹¤ìˆ˜)

### 2. ê´€ê´‘ì§€ ë²¡í„° ì‚¬ì „ ê³„ì‚°

**ê´€ê´‘ì§€ ë°ì´í„° ë²¡í„°í™”**:
```python
# ê´€ê´‘ì§€ë³„ í…ìŠ¤íŠ¸ êµ¬ì„±
text_content = f"{tour.name}"      # ê´€ê´‘ì§€ ì´ë¦„
if tour.keywords:
    text_content += f" {tour.keywords}"  # í‚¤ì›Œë“œ
if tour.region:
    text_content += f" {tour.region}"    # ì§€ì—­ ì •ë³´

# ë²¡í„° ìƒì„± ë° DB ì €ì¥
tour_vector = embed_text(text_content)
tour.pref_vector = tour_vector  # PostgreSQL Vector ì»¬ëŸ¼ì— ì €ì¥
```

**ì˜ˆì‹œ**:
- `ê¹€ì œì§€í‰ì„ ì¶•ì œ`: `"ê¹€ì œì§€í‰ì„ ì¶•ì œ ë“¤íŒ ì¶•ì œ ì²´í—˜í˜• ê¹€ì œì‹œ"` â†’ ë²¡í„°
- `ì„ ì•”ìì—°íœ´ì–‘ë¦¼`: `"ì„ ì•”ìì—°íœ´ì–‘ë¦¼ ì‚° ìˆ² ì•¼ì™¸í™œë™ íë§ ê¹€ì œì‹œ"` â†’ ë²¡í„°

### 3. ì½”ì‚¬ì¸ ìœ ì‚¬ë„ ê³„ì‚° (`vector_similarity_service.py`)

#### ìˆ˜ì‹ ê¸°ë°˜ ê³„ì‚°:

```python
def calculate_cosine_similarity(self, vec1: List[float], vec2: List[float]) -> float:
    """ì½”ì‚¬ì¸ ìœ ì‚¬ë„ = cos(Î¸) = (AÂ·B) / (|A| Ã— |B|)"""
    
    a = np.array(vec1, dtype=np.float32)  # ì‚¬ìš©ì ì¿¼ë¦¬ ë²¡í„°
    b = np.array(vec2, dtype=np.float32)  # ê´€ê´‘ì§€ ë²¡í„°
    
    # ë²¡í„° í¬ê¸°(ë…¸ë¦„) ê³„ì‚°
    norm_a = np.linalg.norm(a)  # |A|
    norm_b = np.linalg.norm(b)  # |B|
    
    # ì½”ì‚¬ì¸ ìœ ì‚¬ë„ ê³„ì‚°
    similarity = np.dot(a, b) / (norm_a * norm_b)  # cos(Î¸)
    
    # 0-1 ì‚¬ì´ ê°’ìœ¼ë¡œ ì •ê·œí™”
    return float((similarity + 1) / 2)
```

#### PostgreSQL + pgvector ìµœì í™”:

```sql
SELECT 
    id, name, region, keywords,
    (pref_vector <-> :query_vector::vector) as distance,
    (1 - (pref_vector <-> :query_vector::vector)) as similarity
FROM tour_spots 
WHERE pref_vector IS NOT NULL
ORDER BY pref_vector <-> :query_vector::vector  -- ê±°ë¦¬ìˆœ ì •ë ¬
LIMIT 10
```

### 4. ì˜ë¯¸ì  ê²€ìƒ‰ì˜ ì‹¤ì œ ë™ì‘

#### ì…ë ¥ ì˜ˆì‹œ: `"ê¹€ì œì—ì„œ ì‚¬ê³¼ë”°ê¸° ì²´í—˜í•˜ê³  ì‹¶ì–´"`

**1ë‹¨ê³„**: ì¿¼ë¦¬ ë²¡í„°í™”
```
"ê¹€ì œì—ì„œ ì‚¬ê³¼ë”°ê¸° ì²´í—˜í•˜ê³  ì‹¶ì–´" â†’ [0.12, -0.45, 0.78, ...]
```

**2ë‹¨ê³„**: ê´€ê´‘ì§€ ë²¡í„°ë“¤ê³¼ ìœ ì‚¬ë„ ê³„ì‚°
```
ê¹€ì œì§€í‰ì„ ì¶•ì œ ë²¡í„°: [0.15, -0.42, 0.81, ...] â†’ ìœ ì‚¬ë„: 0.89
ì„ ì•”ìì—°íœ´ì–‘ë¦¼ ë²¡í„°: [0.21, -0.38, 0.72, ...] â†’ ìœ ì‚¬ë„: 0.76
ê¹€ì œí–¥êµ ë²¡í„°:       [0.08, -0.51, 0.65, ...] â†’ ìœ ì‚¬ë„: 0.65
```

**3ë‹¨ê³„**: ì˜ë¯¸ì  ì—°ê²° ì´í•´
- `"ì‚¬ê³¼ë”°ê¸°"` â†” `"ê³¼ìˆ˜ì› ì²´í—˜"` âœ“ (ë†’ì€ ìœ ì‚¬ë„)
- `"ì²´í—˜"` â†” `"ë†ì—… ê´€ê´‘"` âœ“ (ë†’ì€ ìœ ì‚¬ë„)  
- `"ê¹€ì œ"` â†” `"ê¹€ì œì‹œ"` âœ“ (ì§€ì—­ ë§¤ì¹­)

## ğŸ§  í‚¤ì›Œë“œ ë§¤ì¹­ ëŒ€ë¹„ ë²¡í„° ê²€ìƒ‰ì˜ ì¥ì 

### í‚¤ì›Œë“œ ë§¤ì¹­ì˜ í•œê³„
```python
# ê¸°ì¡´ ë°©ì‹ - ì •í™•íˆ ë§¤ì¹­ë˜ëŠ” ë‹¨ì–´ë§Œ ê²€ìƒ‰
if "ì‚¬ê³¼" in attraction_keywords:
    score += 1

# ê²°ê³¼: "ê³¼ìˆ˜ì›", "ê³¼ì¼ ì²´í—˜"ì€ ë§¤ì¹­ ì‹¤íŒ¨
```

### ë²¡í„° ê²€ìƒ‰ì˜ ì˜ë¯¸ ì´í•´
```python
# ë²¡í„° ë°©ì‹ - ì˜ë¯¸ì  ìœ ì‚¬ì„± ì´í•´
similarity = cosine_similarity(
    embed_text("ì‚¬ê³¼ë”°ê¸° ì²´í—˜"),
    embed_text("ê³¼ìˆ˜ì› ë†ì—… ê´€ê´‘")
)
# ê²°ê³¼: 0.87 (ë†’ì€ ìœ ì‚¬ë„ë¡œ ë§¤ì¹­ ì„±ê³µ!)
```

## ğŸ’¡ ì‹¤ì œ ê²€ìƒ‰ ì˜ˆì‹œ ë¹„êµ

### ì¿¼ë¦¬: "ê¹€ì œì—ì„œ ê³¼ì¼ ë†ì‚¬ ë„ìš°ê³  ì‹¶ì–´ìš”"

#### í‚¤ì›Œë“œ ë§¤ì¹­ ê²°ê³¼:
```
âŒ "ê³¼ì¼" í‚¤ì›Œë“œê°€ ì—†ëŠ” ê´€ê´‘ì§€ëŠ” ì œì™¸
âŒ "ì‚¬ê³¼ ì²´í—˜ì¥"ì€ ê²€ìƒ‰ë˜ì§€ ì•ŠìŒ
âŒ "ë†ì—… ê´€ê´‘ì§€"ë„ ëˆ„ë½
```

#### ë²¡í„° ê²€ìƒ‰ ê²°ê³¼:
```
âœ… ì‚¬ê³¼ ì²´í—˜ ë†ì¥ (ìœ ì‚¬ë„: 0.91) - "ê³¼ì¼" â†” "ì‚¬ê³¼" ì˜ë¯¸ ì—°ê²°
âœ… ë†ì—… ì²´í—˜ ê´€ê´‘ì§€ (ìœ ì‚¬ë„: 0.87) - "ë†ì‚¬" â†” "ë†ì—… ì²´í—˜" ì—°ê²°  
âœ… ê³¼ìˆ˜ì› íˆ¬ì–´ (ìœ ì‚¬ë„: 0.84) - "ê³¼ì¼ ë†ì‚¬" â†” "ê³¼ìˆ˜ì›" ì—°ê²°
```

## ğŸ”„ ê°œì¸í™” ì¶”ì²œ ì‹œìŠ¤í…œ

### ì‚¬ìš©ì í”„ë¡œí•„ ë²¡í„° ìƒì„±
```python
# ì‚¬ìš©ì ì„ í˜¸ë„ ì…ë ¥
preferences = ["ìì—° í’ê²½", "ì²´í—˜ í™œë™", "íë§", "ì‚¬ê³¼"]

# ê°ê°ì„ ë²¡í„°ë¡œ ë³€í™˜ í›„ í‰ê· 
pref_vectors = embed_texts(preferences)
user_vector = average_embeddings(pref_vectors)  # ì‚¬ìš©ì í”„ë¡œí•„ ë²¡í„°
```

### í•˜ì´ë¸Œë¦¬ë“œ ì¶”ì²œ
```python
# ì¿¼ë¦¬ ë²¡í„° + ì‚¬ìš©ì ë²¡í„° ê²°í•©
query_vector = embed_text("ê¹€ì œ ê´€ê´‘ì§€ ì¶”ì²œí•´ì¤˜")
user_vector = get_user_preference_vector(user_id)

# ê°€ì¤‘ í‰ê· ìœ¼ë¡œ í•˜ì´ë¸Œë¦¬ë“œ ë²¡í„° ìƒì„±
hybrid_vector = (0.7 * query_vector) + (0.3 * user_vector)

# ê°œì¸í™”ëœ ê²€ìƒ‰ ì‹¤í–‰
results = find_similar_tours_with_vector(hybrid_vector)
```

## ğŸ“Š ì„±ëŠ¥ ë° í™•ì¥ì„±

### ê²€ìƒ‰ ì„±ëŠ¥
- **pgvector ì¸ë±ìŠ¤**: O(log n) ê²€ìƒ‰ ì„±ëŠ¥
- **ë°°ì¹˜ ì„ë² ë”©**: 1000ê°œì”© ë¬¶ì–´ì„œ API í˜¸ì¶œ ìµœì í™”
- **ìºì‹±**: ì¤‘ë³µ ì¿¼ë¦¬ ë²¡í„° ìƒì„± ë°©ì§€

### í™•ì¥ì„±
- **ìƒˆ ì½˜í…ì¸ **: ì¦‰ì‹œ ë²¡í„° ìƒì„±í•˜ì—¬ ê²€ìƒ‰ ëŒ€ìƒ ì¶”ê°€ ê°€ëŠ¥
- **ë‹¤êµ­ì–´**: ì„ë² ë”© ëª¨ë¸ì´ í•œêµ­ì–´-ì˜ì–´ ë™ì‹œ ì§€ì›
- **ì¹´í…Œê³ ë¦¬ ë¬´ê´€**: ë†ê°€, ê´€ê´‘ì§€, ìˆ™ë°•, ìŒì‹ì  ë™ì¼í•œ ë°©ì‹ ì ìš©

## ğŸ¯ ì‹¤ì œ êµ¬í˜„ëœ API ì‚¬ìš©ë²•

### 1. ê¸°ë³¸ ë²¡í„° ê²€ìƒ‰
```python
from advanced_features.vector_similarity_service import get_vector_similarity_service

service = get_vector_similarity_service()

# ê´€ê´‘ì§€ ë²¡í„° ê²€ìƒ‰
results = service.find_similar_tours_by_vector(
    db=db_session,
    query_text="ê¹€ì œì—ì„œ ì‚¬ê³¼ë”°ê¸° ì²´í—˜í•˜ê³  ì‹¶ì–´",
    region="ê¹€ì œì‹œ",
    limit=10,
    similarity_threshold=0.7
)

print(f"ê²€ìƒ‰ ê²°ê³¼: {len(results)}ê°œ")
for result in results:
    print(f"- {result['name']} (ìœ ì‚¬ë„: {result['similarity_score']:.2f})")
```

### 2. ê°œì¸í™” ì¶”ì²œ
```python
from advanced_features.vector_recommendation_engine import get_vector_recommendation_engine

engine = get_vector_recommendation_engine()

# ê°œì¸í™” ì¶”ì²œ
recommendations = engine.get_personalized_recommendations(
    db=db_session,
    user_id=123,
    query_text="ê°€ì„ì— ë†ì—… ì²´í—˜í•˜ê³  ì‹¶ì–´ìš”",
    region="ê¹€ì œì‹œ",
    job_limit=5,
    tour_limit=8
)

print("ê°œì¸í™” ì¶”ì²œ ê²°ê³¼:")
for tour in recommendations['tours']:
    scores = tour['scores']
    print(f"- {tour['name']}")
    print(f"  ë²¡í„° ìœ ì‚¬ë„: {scores['vector_similarity']:.2f}")
    print(f"  ê°œì¸ ì„ í˜¸ë„: {scores['user_preference']:.2f}")
    print(f"  ìµœì¢… ì ìˆ˜: {scores['personalization_score']:.2f}")
```

## ğŸ”§ ì‹œìŠ¤í…œ ì„¤ì • ë° ì´ˆê¸°í™”

### ë°ì´í„°ë² ì´ìŠ¤ ë²¡í„° ì—…ë°ì´íŠ¸
```python
# ê´€ê´‘ì§€ ë²¡í„° ì¼ê´„ ìƒì„±
service = get_vector_similarity_service()
stats = service.update_content_vectors(db, content_type="tour")
print(f"ì—…ë°ì´íŠ¸ ì™„ë£Œ: {stats['updated']}ê°œ ê´€ê´‘ì§€")

# ë†ê°€ ë²¡í„° ì¼ê´„ ìƒì„±  
stats = service.update_content_vectors(db, content_type="job")
print(f"ì—…ë°ì´íŠ¸ ì™„ë£Œ: {stats['updated']}ê°œ ë†ê°€")
```

## ğŸ‰ ì •ë¦¬

ì´ì œ **advanced_features**ì—ëŠ” ì™„ì „íˆ ë™ì‘í•˜ëŠ” ë²¡í„° ê¸°ë°˜ ì˜ë¯¸ì  ê²€ìƒ‰ ì‹œìŠ¤í…œì´ êµ¬í˜„ë˜ì–´ ìˆìŠµë‹ˆë‹¤:

1. âœ… **OpenAI text-embedding-3-small**ë¡œ ìì—°ì–´ë¥¼ 1536ì°¨ì› ë²¡í„° ë³€í™˜
2. âœ… **ì½”ì‚¬ì¸ ìœ ì‚¬ë„ ê³„ì‚°** í•¨ìˆ˜ êµ¬í˜„  
3. âœ… **PostgreSQL + pgvector** ì¿¼ë¦¬ ë¡œì§
4. âœ… **ê°œì¸í™” ì¶”ì²œ** ì—”ì§„
5. âœ… **í•˜ì´ë¸Œë¦¬ë“œ ê²€ìƒ‰** (ì¿¼ë¦¬ + ì‚¬ìš©ì ì„ í˜¸ë„)

í‚¤ì›Œë“œ ë§¤ì¹­ìœ¼ë¡œëŠ” ë¶ˆê°€ëŠ¥í•œ `"ì‚¬ê³¼ë”°ê¸°" â†” "ê³¼ìˆ˜ì› ì²´í—˜"`, `"ë†ì‚¬" â†” "ë†ì—… ê´€ê´‘"` ê°™ì€ **ì˜ë¯¸ì  ì—°ê²°**ì„ ì •í™•íˆ ì´í•´í•˜ê³  ì¶”ì²œí•  ìˆ˜ ìˆëŠ” ì‹œìŠ¤í…œì…ë‹ˆë‹¤!